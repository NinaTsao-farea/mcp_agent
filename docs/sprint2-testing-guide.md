# Sprint 2 測試指南

## 概述

本文檔說明如何測試 Sprint 2 實作的續約流程 Step 1-4 功能。

## 測試環境準備

### 1. 啟動後端服務

```powershell
cd backend
python run_app.py
```

後端服務應該在 `http://localhost:5000` 啟動。

### 2. 啟動前端服務

```powershell
cd frontend
pnpm run dev
```

前端服務應該在 `http://localhost:3000` 啟動。

### 3. 登入系統

使用以下測試帳號登入：

- 帳號：`staff001`
- 密碼：`password123`

## 測試場景

### 場景 1：成功的續約流程（主要門號即將到期）

**測試資料：**
- 客戶身分證：`A123456789`
- 客戶姓名：張三
- 門號數量：2個

**測試步驟：**

1. **Step 1 - 查詢客戶**
   - 在首頁點擊「開始續約」
   - 輸入身分證號：`A123456789`
   - 點擊「查詢客戶」或按 Enter
   - ✅ 驗證：應該顯示「張三」的客戶資料

2. **Step 2 - 門號列表**
   - ✅ 驗證：應該顯示 2 個門號卡片
   - 門號 1：`0912-345-678`（主要門號）
     - 月費：$1399
     - 方案：4G 飆速方案 50GB
     - 合約到期日：應該接近當前日期（60天內）
     - 狀態：正常
   - 門號 2：`0987-654-321`（副門號）
     - 月費：$599
     - 方案：4G 經濟方案 10GB
     - 合約到期日：應該還有很長時間
     - 狀態：正常

3. **Step 3 - 選擇門號（即將到期的主要門號）**
   - 點擊第一個門號卡片（`0912-345-678`）
   - ✅ 驗證：卡片應該高亮顯示（藍色邊框）
   - ✅ 驗證：應該自動進行資格檢查

4. **Step 4 - 資格檢查結果（通過）**
   - ✅ 驗證：應該顯示綠色成功圖示
   - ✅ 驗證：標題為「符合續約資格」
   - ✅ 驗證：顯示 3 個檢查項目：
     - ✅ 合約到期時間檢查：即將到期，可續約
     - ✅ 帳單繳清檢查：無欠費
     - ✅ 信用檢查：信用良好
   - 點擊「繼續選擇方案」
   - ✅ 驗證：應該顯示「Step 5-10 將在 Sprint 3 實作」提示

---

### 場景 2：選擇未到期門號（不符資格）

**測試資料：**
- 客戶身分證：`A123456789`
- 選擇門號：`0987-654-321`（副門號，未到期）

**測試步驟：**

1. 重複場景 1 的 Step 1-2

2. **Step 3 - 選擇未到期門號**
   - 點擊第二個門號卡片（`0987-654-321`）
   - ✅ 驗證：應該自動進行資格檢查

3. **Step 4 - 資格檢查結果（不通過）**
   - ✅ 驗證：應該顯示紅色失敗圖示
   - ✅ 驗證：標題為「不符合續約資格」
   - ✅ 驗證：顯示檢查項目，其中至少一項為失敗狀態
   - ❌ 合約到期時間檢查：合約到期日尚早，無法續約
   - ✅ 帳單繳清檢查：無欠費
   - ✅ 信用檢查：信用良好
   - 點擊「選擇其他門號」
   - ✅ 驗證：應該返回門號列表

---

### 場景 3：欠費客戶（不符資格）

**測試資料：**
- 客戶身分證：`B987654321`
- 客戶姓名：李四
- 門號數量：1個

**測試步驟：**

1. **Step 1 - 查詢客戶**
   - 輸入身分證號：`B987654321`
   - ✅ 驗證：應該顯示「李四」的客戶資料

2. **Step 2 - 門號列表**
   - ✅ 驗證：應該顯示 1 個門號卡片
   - 門號：`0988-123-456`
     - 月費：$799
     - 方案：5G 暢遊方案 20GB
     - 合約到期日：應該接近當前日期

3. **Step 3 - 選擇門號**
   - 點擊門號卡片

4. **Step 4 - 資格檢查結果（不通過）**
   - ✅ 驗證：應該顯示不符合資格
   - ✅ 驗證：檢查項目中「帳單繳清檢查」為失敗狀態
   - ❌ 帳單繳清檢查：有未繳帳單，無法續約

---

### 場景 4：非本公司客戶

**測試資料：**
- 客戶身分證：`C111222333`
- 客戶姓名：王五

**測試步驟：**

1. **Step 1 - 查詢客戶**
   - 輸入身分證號：`C111222333`
   - 點擊「查詢客戶」
   - ✅ 驗證：應該顯示錯誤訊息
   - ✅ 錯誤訊息：「此客戶不是本公司用戶」

---

### 場景 5：不存在的客戶

**測試資料：**
- 客戶身分證：`X000000000`

**測試步驟：**

1. **Step 1 - 查詢客戶**
   - 輸入身分證號：`X000000000`
   - 點擊「查詢客戶」
   - ✅ 驗證：應該顯示錯誤訊息
   - ✅ 錯誤訊息：「查無此客戶」

---

## UI 元素驗證

### 進度指示器

- ✅ 應該顯示 4 個步驟：查詢客戶、選擇門號、資格檢查、選擇方案
- ✅ 當前步驟應該高亮（藍色圓圈）
- ✅ 已完成步驟應該顯示為完成狀態
- ✅ 步驟間的連接線應該根據完成狀態變色

### 客戶資訊卡片

- ✅ 應該顯示客戶姓名、電話、Email（如果有）
- ✅ 樣式應該與門號卡片區分開

### 門號卡片

- ✅ 應該清楚顯示門號、月費、方案名稱
- ✅ 應該有主要/副門號標籤
- ✅ 應該有狀態標籤（正常/暫停等）
- ✅ 點擊時應該有視覺反饋（邊框高亮）
- ✅ 合約到期日應該格式化為易讀格式（年/月/日）
- ✅ 摺疊面板應該能展開顯示詳細資訊：
  - 合約資訊（合約期間、已使用月數、語音分鐘等）
  - 使用量資訊（數據、語音用量）
  - 帳單資訊（本月帳單、繳費狀態）

### 資格檢查結果

- ✅ 成功時顯示綠色圖示和訊息
- ✅ 失敗時顯示紅色圖示和訊息
- ✅ 每個檢查項目應該有清楚的通過/失敗狀態
- ✅ 失敗項目應該顯示失敗原因

### 載入狀態

- ✅ 查詢客戶時應該顯示 Loading 狀態
- ✅ 選擇門號時應該顯示 Loading 狀態
- ✅ Loading 期間按鈕應該被禁用

### 錯誤處理

- ✅ 輸入框下方應該顯示錯誤訊息
- ✅ 錯誤訊息應該是紅色且易讀
- ✅ 清除錯誤狀態時訊息應該消失

---

## 技術驗證

### Session 管理

1. **創建 Session**
   - 打開瀏覽器開發者工具（F12）
   - 切換到 Application/Storage 分頁
   - 檢查 localStorage
   - ✅ 應該有 `renewal_session_id` 鍵

2. **Session 持久化**
   - 完成 Step 1-2
   - 重新整理頁面（F5）
   - ✅ 驗證：應該恢復到之前的狀態
   - ✅ 客戶資料應該還在
   - ✅ 門號列表應該還在

3. **清除 Session**
   - 點擊導航列的返回按鈕
   - 確認離開
   - 檢查 localStorage
   - ✅ Session ID 應該被保留（可以繼續）

### API 呼叫

打開瀏覽器開發者工具 Network 分頁：

1. **POST /api/renewal-workflow/start**
   - ✅ 應該在頁面載入時被呼叫
   - ✅ Response 應該包含 `session_id`

2. **POST /api/renewal-workflow/step/query-customer**
   - ✅ 應該在輸入身分證號後被呼叫
   - ✅ Request body: `{ "id_number": "A123456789" }`
   - ✅ Response 應該包含客戶資料

3. **POST /api/renewal-workflow/step/list-phones**
   - ✅ 應該在查詢客戶成功後自動被呼叫
   - ✅ Response 應該包含門號陣列，每個門號包含 contract、usage、billing 資訊

4. **POST /api/renewal-workflow/step/select-phone**
   - ✅ 應該在點擊門號卡片時被呼叫
   - ✅ Request body: `{ "phone_number": "0912-345-678" }`
   - ✅ Response 應該包含 `eligibility_check` 物件

### 錯誤處理

1. **後端服務未啟動**
   - 停止後端服務
   - 嘗試查詢客戶
   - ✅ 應該顯示網路錯誤訊息

2. **Session 過期**
   - 等待 Session 過期（1 小時）或手動刪除 Redis 中的 Session
   - 嘗試繼續操作
   - ✅ 應該自動創建新 Session

---

## 測試資料總結

| 身分證號 | 客戶姓名 | 門號數量 | 續約資格 | 備註 |
|---------|---------|---------|---------|------|
| A123456789 | 張三 | 2 | 主要門號：✅ 符合<br>副門號：❌ 未到期 | 主要門號即將到期 |
| B987654321 | 李四 | 1 | ❌ 有欠費 | 有未繳帳單 |
| C111222333 | 王五 | - | ❌ 非本公司客戶 | 查詢會失敗 |
| X000000000 | - | - | ❌ 不存在 | 查詢會失敗 |

---

## 已知限制

1. **Mock 資料**：目前使用 Mock CRM Service，資料是硬編碼的
2. **Step 5-10 未實作**：點擊「繼續選擇方案」會顯示提示訊息
3. **AI 對話未整合**：AI 助理功能將在 Sprint 3 實作
4. **統計資料**：首頁的統計資料目前是 Mock 資料

---

## 回報問題

測試過程中如果發現問題，請記錄：

1. 測試場景編號
2. 重現步驟
3. 預期結果
4. 實際結果
5. 截圖（如果適用）
6. 瀏覽器 Console 錯誤訊息
7. Network 分頁的 API 錯誤

---

## 下一步（Sprint 3）

以下功能將在 Sprint 3 實作：

- Step 5-7：手機選擇流程
- Step 8-9：方案選擇與比較
- Step 10：確認與提交
- AI 對話整合
- 完整的錯誤處理與重試機制
- 真實 CRM API 整合
