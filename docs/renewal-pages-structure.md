# 續約流程頁面結構示意圖

## 📁 文件結構

```
frontend/pages/
│
├── 📄 renewal.vue                    # 主布局頁面
│   ├── AppNavbar（返回按鈕 + 標題）
│   ├── 進度條（4步驟指示器）
│   └── <NuxtPage />（子頁面容器）
│
└── 📁 renewal/
    ├── 📄 index.vue                  # 重定向入口
    ├── 📄 query-customer.vue         # Step 1
    ├── 📄 select-phone.vue           # Step 2
    ├── 📄 eligibility.vue            # Step 3
    └── 📄 select-plan.vue            # Step 4
```

## 🔄 導航流程

```
                     ┌──────────────┐
                     │   首頁 (/)   │
                     └──────┬───────┘
                            │ 點擊「開始續約」
                            ▼
                   ┌─────────────────┐
                   │ /renewal        │
                   │  (自動重定向)    │
                   └────────┬─────────┘
                            │
                            ▼
        ┌──────────────────────────────────────┐
        │   /renewal/query-customer (Step 1)   │
        │   查詢客戶資料                        │
        │   - 輸入身分證號                      │
        │   - 驗證客戶身份                      │
        └──────────────────┬────────────────────┘
                           │ 查詢成功
                           ▼
        ┌──────────────────────────────────────┐
        │   /renewal/select-phone (Step 2)     │
        │   選擇門號                            │
        │   - 顯示客戶資訊                      │
        │   - 列出所有門號                      │
        │   - 選擇要續約的門號                  │
        └──────────────────┬────────────────────┘
                           │ 選擇門號
                           ▼
        ┌──────────────────────────────────────┐
        │   /renewal/eligibility (Step 3)      │
        │   資格檢查結果                        │
        │   - 顯示檢查項目                      │
        │   - 合約期限檢查                      │
        │   - 帳單狀態檢查                      │
        └──────────────────┬────────────────────┘
                           │ 符合資格
                           ▼
        ┌──────────────────────────────────────┐
        │   /renewal/select-plan (Step 4)      │
        │   選擇方案                            │
        │   - Sprint 3 實作                     │
        └───────────────────────────────────────┘
```

## 🔙 返回邏輯

```
Step 1 (query-customer)  ──返回──▶  首頁 (/)
      ▲
      │
      └── Step 2 (select-phone)
              ▲
              │
              └── Step 3 (eligibility)
                      ▲
                      │
                      └── Step 4 (select-plan)
```

## 📊 進度條顯示

```
Step 1: 查詢客戶
┌───┐     ┌───┐     ┌───┐     ┌───┐
│ ● │─────│   │─────│   │─────│   │
└───┘     └───┘     └───┘     └───┘
 查詢      選擇      資格      選擇
 客戶      門號      檢查      方案

Step 2: 選擇門號
┌───┐     ┌───┐     ┌───┐     ┌───┐
│ ✓ │─────│ ● │─────│   │─────│   │
└───┘     └───┘     └───┘     └───┘
 查詢      選擇      資格      選擇
 客戶      門號      檢查      方案

Step 3: 資格檢查
┌───┐     ┌───┐     ┌───┐     ┌───┐
│ ✓ │─────│ ✓ │─────│ ● │─────│   │
└───┘     └───┘     └───┘     └───┘
 查詢      選擇      資格      選擇
 客戶      門號      檢查      方案

Step 4: 選擇方案
┌───┐     ┌───┐     ┌───┐     ┌───┐
│ ✓ │─────│ ✓ │─────│ ✓ │─────│ ● │
└───┘     └───┘     └───┘     └───┘
 查詢      選擇      資格      選擇
 客戶      門號      檢查      方案

圖例：
● = 當前步驟（藍色高亮 + 光圈）
✓ = 已完成步驟（藍色實心）
  = 未完成步驟（灰色）
```

## 🔐 路由保護

每個子頁面都有前置檢查：

```typescript
// query-customer.vue
// ✅ 任何時候都可訪問

// select-phone.vue
if (!customer.value) {
  navigateTo('/renewal/query-customer')
}

// eligibility.vue
if (!selectedPhone.value) {
  navigateTo('/renewal/select-phone')
}

// select-plan.vue
if (!eligibilityCheck.value || !eligibilityCheck.value.eligible) {
  navigateTo('/renewal/eligibility')
}
```

## 📦 狀態管理

所有頁面共享 `useRenewalWorkflow()` 狀態：

```
┌─────────────────────────────────────┐
│   useRenewalWorkflow() Composable   │
├─────────────────────────────────────┤
│  sessionId        - 工作流會話 ID   │
│  customer         - 客戶資料         │
│  phones           - 門號列表         │
│  selectedPhone    - 選中的門號       │
│  eligibilityCheck - 資格檢查結果     │
│  loading          - 載入狀態         │
│  error            - 錯誤訊息         │
└─────────────────────────────────────┘
           ▲         ▲         ▲
           │         │         │
    ┌──────┴───┬─────┴───┬─────┴────┐
    │          │         │          │
query-customer select-phone eligibility select-plan
```

## 🎨 UI 組件層級

```
renewal.vue (主頁面)
├── AppNavbar
│   ├── 返回按鈕
│   ├── 標題
│   └── 用戶資訊 + 登出
├── ProgressBar
│   └── 4個步驟圓圈
└── <NuxtPage>
    └── 子頁面內容
        ├── query-customer.vue
        │   ├── 輸入框
        │   ├── 查詢按鈕
        │   └── 測試提示
        ├── select-phone.vue
        │   ├── 客戶資訊卡
        │   └── 門號卡片列表
        ├── eligibility.vue
        │   ├── 結果圖示
        │   ├── 檢查項目列表
        │   └── 操作按鈕
        └── select-plan.vue
            └── 佔位內容
```

## 📈 代碼複雜度對比

```
重構前:
┌─────────────────────────────────────┐
│ renewal/index.vue                   │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│ 573 行 (Step 1 + 2 + 3 + 4)        │
│ 複雜度: 高 🔴                        │
└─────────────────────────────────────┘

重構後:
┌─────────────────┐  ┌─────────────────┐
│ renewal.vue     │  │ query-customer  │
│ ━━━━━━━━━━━━━━ │  │ ━━━━━━━━━━━━━━ │
│ 120 行 (布局)   │  │ 90 行 (Step 1)  │
│ 複雜度: 低 🟢   │  │ 複雜度: 低 🟢   │
└─────────────────┘  └─────────────────┘

┌─────────────────┐  ┌─────────────────┐
│ select-phone    │  │ eligibility     │
│ ━━━━━━━━━━━━━━ │  │ ━━━━━━━━━━━━━━ │
│ 180 行 (Step 2) │  │ 150 行 (Step 3) │
│ 複雜度: 中 🟡   │  │ 複雜度: 低 🟢   │
└─────────────────┘  └─────────────────┘

         ┌─────────────────┐
         │ select-plan     │
         │ ━━━━━━━━━━━━━━ │
         │ 50 行 (Step 4)  │
         │ 複雜度: 低 🟢   │
         └─────────────────┘
```

## ✅ 重構效益

| 指標 | 重構前 | 重構後 | 改善 |
|------|--------|--------|------|
| 單文件行數 | 573 | 50-180 | ✅ -68% ~ -90% |
| 職責數量 | 4 in 1 | 1 per file | ✅ 職責分離 |
| 測試難度 | 高 | 低 | ✅ 可單獨測試 |
| 並行開發 | 困難 | 容易 | ✅ 多人協作 |
| URL 可讀性 | 無 | 有 | ✅ 每步有獨立 URL |
| 可維護性 | 低 | 高 | ✅ 易於修改 |
| 擴展性 | 困難 | 容易 | ✅ 新增步驟簡單 |
